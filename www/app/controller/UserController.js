/*
 * File: app/controller/UserController.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.2.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Roadpech.controller.UserController', {
    extend: 'Ext.app.Controller',

    config: {
        views: [
            'Login'
        ],

        routes: {
            'login': 'showLogin'
        },

        refs: {
            loginView: {
                autoCreate: true,
                selector: 'loginView',
                xtype: 'loginView'
            },
            mainView: {
                autoCreate: true,
                selector: 'mainView',
                xtype: 'mainView'
            }
        },

        control: {
            "loginView": {
                signInCommand: 'onSignInCommand',
                signUpCommand: 'onSignUpCommand'
            }
        }
    },
    
    onSignUpCommand: function(item, username, password) {
        var me = this,
            loginView = me.getLoginView();
        loginView.setMasked({
            xtype: 'loadmask',
            message: 'Signing Up...'
        });
        Ext.Ajax.request({
                 url: 'http://roadpech.ideawide.com/api/index.php/user',
                 params: {
                	username : username,
                 	password: password
                 },
                 method: 'POST',
                 success: function (response) {
		        Ext.Msg.alert('Sucess', 'Account added.');
        		loginView.setMasked(false);
	         },
        	 failure: function (response) {
            		Ext.Msg.alert('Error', 'Account creating failed.');
		        loginView.setMasked(false);
   	         }
        });
    },	
    onSignInCommand: function(item, username, password) {
        var me = this,
            loginView = me.getLoginView();

        if (username.length === 0 || password.length === 0) {
            Ext.Msg.alert('Error', 'Please enter a username and a password');
            return;
        }

        loginView.setMasked({
            xtype: 'loadmask',
            message: 'Signing In...'
        });


        var task;
        Ext.Ajax.request({
                 url: 'http://roadpech.ideawide.com/api/index.php/login',
                 params: {
                	username : username,
                 	password: password
                 },
                 method: 'POST',
                 success: function (response) {
	       	     task = Ext.create('Ext.util.DelayedTask', function () {
	        	    me.signInSuccess(); 
		     });
        	     task.delay(500);
	        },
        	failure: function (response) {
        	     task = Ext.create('Ext.util.DelayedTask', function () {
		            me.signInFailure("Invalid Username or Password"); 
		      });
        	      task.delay(500);
	        }
        });
    },

    signInFailure: function(msg) {
        var loginView = this.getLoginView();
        loginView.setMasked(false);
        Ext.Msg.alert('Error', msg);
    },

    signInSuccess: function() {
        var loginView = this.getLoginView();
        loginView.setMasked(false);
        this.redirectTo('map')

    },

    showLogin: function() {
        Ext.Viewport.setActiveItem(this.getLoginView());
    },

    

});
